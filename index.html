<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script>
  var chart = echarts.init(document.getElementById('galaxy'));

  function buildOption() {
    var w = chart.getWidth();
    var h = chart.getHeight();
    var minSide = Math.min(w, h);

    var cx = w * 0.5;
    var cy = h * 0.56;

    // 让图“扩散一些”：三个环的半径适当调大
    var rCore = minSide * 0.09;
    var r1    = minSide * 0.24;
    var r2    = minSide * 0.38;
    var r3    = minSide * 0.50;

    var nodes = [];

    /* 虚化背景圆，仅发光，不带标签和连线 */
    nodes.push({
      id: 'coreHalo',
      name: '',
      x: cx,
      y: cy,
      symbolSize: rCore * 1.8,
      itemStyle: {
        color: 'rgba(56,189,248,0.14)',
        shadowBlur: 90,
        shadowColor: 'rgba(56,189,248,0.9)',
        borderWidth: 0
      },
      label: { show: false },
      z: 0
    });

    // 中心节点（英文大标题）
    nodes.push({
      id: 'core',
      name: 'StarTimes UGANDA\nMARKET SYSTEM',
      x: cx,
      y: cy,
      symbolSize: rCore,
      itemStyle: {
        color: '#38bdf8',
        shadowBlur: 46,
        shadowColor: 'rgba(56,189,248,0.95)',
        borderWidth: 0
      },
      label: {
        show: true,
        fontFamily: 'Barlow Condensed, sans-serif',
        fontSize: 40,
        fontWeight: 700,
        color: '#ffffff',
        lineHeight: 40
      },
      z: 1
    });

    // 第一圈：两个一级目录（带链接）
    var ring1 = [
      {
        id: 'eco',
        name: 'Ecology\n生态',
        angle: -60 * Math.PI / 180,
        color: '#facc15',
        link: 'ecology/index.html',
        tip: 'Ecology · 业务生态：DVB、Solar、OTT、设备与广告等业务组合'
      },
      {
        id: 'niche',
        name: 'Niche\n生态位',
        angle: (180 + 35) * Math.PI / 180,
        color: '#22c55e',
        link: 'niche/index.html',
        tip: 'Niche · 生态位体系：空间生态位、市场生态位、渠道与受众结构'
      }
    ];

    ring1.forEach(function (n) {
      var x = cx + r1 * Math.cos(n.angle);
      var y = cy + r1 * Math.sin(n.angle);
      nodes.push({
        id: n.id,
        name: n.name,
        x: x,
        y: y,
        symbolSize: minSide * 0.16,
        itemStyle: {
          color: n.color,
          shadowBlur: 40,
          shadowColor: n.color,
          borderColor: 'rgba(15,23,42,0.7)',
          borderWidth: 0
        },
        label: {
          show: true,
          fontFamily: 'Barlow Condensed, sans-serif',
          fontSize: 26,
          fontWeight: 600,
          color: '#ffffff',
          lineHeight: 26
        },
        link: n.link,
        tooltip: { formatter: n.tip },
        z: 2
      });
    });

    // 第二圈：Ecology 子层级
    var ecoChildren = [
      { id: 'eco-dvb',   name: 'DVB\nLinear TV',            angleDeg: -5  },
      { id: 'eco-solar', name: 'Solar\nOff-grid',          angleDeg: -50 },
      { id: 'eco-ott',   name: 'OTT App\nStarTimes ON',    angleDeg: 15  },
      { id: 'eco-dev',   name: 'Devices\nSTB / Dish / TV', angleDeg: -90 },
      { id: 'eco-adv',   name: 'Advertising\n& Media',     angleDeg: 40  }
    ];
    ecoChildren.forEach(function (c) {
      var angle = c.angleDeg * Math.PI / 180;
      var x = cx + r2 * Math.cos(angle);
      var y = cy + r2 * Math.sin(angle);
      nodes.push({
        id: c.id,
        name: c.name,
        x: x,
        y: y,
        symbolSize: minSide * 0.055,
        itemStyle: {
          color: '#f97316',
          shadowBlur: 24,
          shadowColor: 'rgba(249,115,22,0.9)',
          borderColor: 'rgba(15,23,42,0.9)',
          borderWidth: 0
        },
        label: {
          show: true,
          fontFamily: 'Barlow Condensed, sans-serif',
          fontSize: 12,
          color: '#fffbeb',
          lineHeight: 12
        },
        tooltip: {
          formatter: 'Ecology · ' + c.name.replace('\n', ' ')
        },
        z: 2
      });
    });

    // 第二圈：Niche 子层级
    var nicheChildren = [
      { id: 'niche-spatial',  name: 'Spatial\nNiche',  angleDeg: 180 + 15  },
      { id: 'niche-market',   name: 'Market\nNiche',   angleDeg: 180 + 60  },
      { id: 'niche-audience', name: 'Audience\nNiche', angleDeg: 180 - 20  },
      { id: 'niche-channel',  name: 'Channel\nNiche',  angleDeg: 180 + 100 }
    ];
    nicheChildren.forEach(function (c) {
      var angle = c.angleDeg * Math.PI / 180;
      var x = cx + r2 * Math.cos(angle);
      var y = cy + r2 * Math.sin(angle);
      nodes.push({
        id: c.id,
        name: c.name,
        x: x,
        y: y,
        symbolSize: minSide * 0.055,
        itemStyle: {
          color: '#a855f7',
          shadowBlur: 24,
          shadowColor: 'rgba(168,85,247,0.9)',
          borderColor: 'rgba(15,23,42,0.9)',
          borderWidth: 0
        },
        label: {
          show: true,
          fontFamily: 'Barlow Condensed, sans-serif',
          fontSize: 12,
          color: '#faf5ff',
          lineHeight: 12
        },
        tooltip: {
          formatter: 'Niche · ' + c.name.replace('\n', ' ')
        },
        z: 2
      });
    });

    // 第三圈：外部环境
    var outer = [
      { id: 'env-competition', name: 'Competition\nDSTv / GOTv / Azam', angleDeg: -120 },
      { id: 'env-economy',     name: 'Macro\nEconomy',                  angleDeg: -160 },
      { id: 'env-regulation',  name: 'Policy\n& Regulation',            angleDeg: -200 },
      { id: 'env-digital',     name: 'Digital\nPlatforms',              angleDeg: 60   },
      { id: 'env-partners',    name: 'Partners\nISPs / Telcos',         angleDeg: 20   },
      { id: 'env-society',     name: 'Audience\nBehaviour',             angleDeg: 220  }
    ];
    outer.forEach(function (c) {
      var angle = c.angleDeg * Math.PI / 180;
      var x = cx + r3 * Math.cos(angle);
      var y = cy + r3 * Math.sin(angle);
      nodes.push({
        id: c.id,
        name: c.name,
        x: x,
        y: y,
        symbolSize: minSide * 0.04,
        itemStyle: {
          color: 'rgba(148,163,184,0.9)',
          shadowBlur: 18,
          shadowColor: 'rgba(15,23,42,0.9)',
          borderColor: 'rgba(15,23,42,0.9)',
          borderWidth: 0
        },
        label: {
          show: true,
          fontFamily: 'Barlow Condensed, sans-serif',
          fontSize: 11,
          color: '#e5e7eb',
          lineHeight: 11
        },
        tooltip: {
          formatter: '外部环境 · ' + c.name.replace('\n', ' ')
        },
        z: 1
      });
    });

    // 连线
    var links = [];
    links.push({ source: 'core', target: 'eco' });
    links.push({ source: 'core', target: 'niche' });
    ecoChildren.forEach(function (c) { links.push({ source: 'eco',   target: c.id }); });
    nicheChildren.forEach(function (c) { links.push({ source: 'niche', target: c.id }); });
    outer.forEach(function (c, idx) {
      var anchor;
      if (idx <= 2) {
        anchor = ecoChildren[idx % ecoChildren.length].id;
      } else {
        anchor = nicheChildren[idx % nicheChildren.length].id;
      }
      links.push({ source: anchor, target: c.id });
    });

    return {
      backgroundColor: 'transparent',
      // 这里的动画时长只在“飞入”那一步真正生效
      animationDuration: 1200,
      animationDurationUpdate: 1200,
      animationEasing: 'cubicOut',
      animationEasingUpdate: 'cubicOut',
      tooltip: {
        formatter: function (params) {
          if (params.data && params.data.tooltip) {
            return params.data.tooltip.formatter;
          }
          return params.name || '';
        }
      },
      series: [
        {
          type: 'graph',
          layout: 'none',
          data: nodes,
          links: links,
          roam: true,
          focusNodeAdjacency: true,
          edgeSymbol: ['none', 'circle'],
          edgeSymbolSize: 3,
          lineStyle: {
            color: 'rgba(148,163,184,0.55)',
            width: 1.2,
            curveness: 0.25
          },
          emphasis: {
            lineStyle: { width: 2, color: '#e5e7eb' },
            label: { fontSize: 13 }
          }
        }
      ]
    };
  }

  // 构造一个“随机散开”的初始状态，用于首屏飞入动画
  function buildRandomOption(targetOption) {
    var opt = JSON.parse(JSON.stringify(targetOption));
    var w = chart.getWidth();
    var h = chart.getHeight();
    var cx = w * 0.5;
    var cy = h * 0.56;
    var spread = Math.min(w, h) * 0.7;

    var data = opt.series[0].data;
    data.forEach(function (d) {
      if (d.id === 'core' || d.id === 'coreHalo') {
        d.x = cx;
        d.y = cy;
      } else {
        d.x = cx + (Math.random() - 0.5) * spread;
        d.y = cy + (Math.random() - 0.5) * spread;
      }
    });

    // 初始随机帧不需要动画
    opt.animationDuration = 0;
    opt.animationDurationUpdate = 0;
    return opt;
  }

  // 首次加载：先随机，再收拢
  var targetOption = buildOption();
  var randomOption = buildRandomOption(targetOption);

  chart.setOption(randomOption, true);
  setTimeout(function () {
    chart.setOption(targetOption, true);
  }, 0);

  // 只有 Ecology / Niche 两个主节点可点击跳转
  chart.on('click', function (params) {
    var d = params.data || {};
    if (d.link) {
      window.location.href = d.link;
    }
  });

  // resize 时直接恢复目标布局（不重复飞入动画）
  window.addEventListener('resize', function () {
    chart.resize();
    chart.setOption(buildOption(), true);
  });
</script>
